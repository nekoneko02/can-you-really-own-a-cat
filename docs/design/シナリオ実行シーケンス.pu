@startuml シナリオ実行シーケンス図

title シナリオ実行の流れ（ビジュアルノベル型）- DDD準拠版

' ====================================================================
' 参加者配置: 左側=クライアント、右側=サーバー
' ====================================================================

actor "プレイヤー" as Player

' クライアントサイド（Presentation層 + ApiClient）
box "クライアントサイド" #LightBlue
participant "GameCanvas\n(React)" as Canvas
participant "シナリオUI\n(React)" as ScenarioUI
participant "EventUI\n(React)" as EventUI
participant "ChoiceUI\n(React)" as ChoiceUI
participant "ResultUI\n(React)" as ResultUI
participant "GameAnimationComponent\n(React)" as PhaserComp
participant "GameAnimation\n(Phaser Scene)" as Animation
participant "GameApiClient\n(ApiClient)" as ApiClient
end box

' サーバーサイド（Application + Domain層）
box "サーバーサイド" #LightYellow
participant "GameService\n(Application)" as Service
participant "SessionStore\n(iron-session)" as SessionStore
participant "Scenario\n(Entity)" as Scenario
participant "Event\n(Entity)" as Event
participant "Choice\n(ValueObject)" as Choice
participant "EventResult\n(ValueObject)" as EventResult
participant "Branch\n(Entity)" as Branch
end box

' クライアント/サーバー共有（セッション経由）
box "共有（セッション）" #LightGreen
participant "Cat\n(Entity)" as Cat
participant "GameSession\n(ValueObject)" as Session
end box

== ゲーム開始 ==

Player -> Canvas: ゲーム開始
activate Canvas

note right of Canvas
  GameCanvas:
  - 上半分: GameAnimationComponent（背景・猫）
  - 下半分: シナリオUI（イベント表示・選択肢・結果）

  2つのコンポーネントは独立
  シナリオUIはEventUI、ChoiceUI、ResultUIを子として持つ
end note

Canvas -> ScenarioUI: init(scenarioId)
activate ScenarioUI

note right of ScenarioUI
  シナリオUIはGameApiClientに依存（ルール1, ルール3準拠）
  子コンポーネント（EventUI, ChoiceUI, ResultUI）へpropsを渡す
end note

ScenarioUI -> ApiClient: loadScenario(scenarioId)
activate ApiClient

note right of ApiClient
  GameApiClient:
  - HTTP経由でサーバー側GameServiceを呼び出し
  - 1 ApplicationService = 1 ApiClient の原則
end note

ApiClient -> Service: POST /api/game/load-scenario
activate Service

note right of Service
  サーバー側で実行:
  1. iron-sessionでセッション初期化または取得
  2. Scenarioをリポジトリから取得
  3. GameSessionとCatを生成
  4. セッションに保存
end note

Service -> SessionStore: getSession() or createSession()
activate SessionStore

note right of SessionStore
  iron-session:
  - セッションIDを自動生成・管理
  - Cookieを暗号化して保存
  - 初回アクセス時は新規作成
end note

SessionStore --> Service: Session
deactivate SessionStore

Service -> Scenario: リポジトリから取得
activate Scenario
Scenario --> Service: Scenario
deactivate Scenario

Service -> Service: GameSession生成\nCat生成（デフォルト値）

Service -> SessionStore: saveSession(gameSession, cat)
activate SessionStore
SessionStore --> Service: 保存完了
deactivate SessionStore

Service --> ApiClient: Scenario（必要な情報のみ）
deactivate Service

ApiClient --> ScenarioUI: Scenario
deactivate ApiClient

ScenarioUI --> Canvas: 準備完了
deactivate ScenarioUI

Canvas -> PhaserComp: init()
activate PhaserComp

note right of PhaserComp
  GameAnimationComponent:
  - Phaser インスタンス管理
  - GameAnimation (Phaser Scene) の初期化
end note

PhaserComp -> Animation: 初期化
activate Animation

note right of Animation
  GameAnimation (Phaser Scene):
  - 背景画像の読み込み
  - 猫のイラストの読み込み
  - エフェクトの準備

  ※Scenarioは呼び出さない
end note

Animation --> PhaserComp: 準備完了
deactivate Animation

PhaserComp --> Canvas: 準備完了
deactivate PhaserComp

Canvas --> Player: ゲーム画面表示
deactivate Canvas

== イベント表示 ==

Player -> ScenarioUI: （自動）
activate ScenarioUI

note right of ScenarioUI
  シナリオUIがGameApiClient経由でサーバー側にアクセス
  （ルール1: UI → ApiClient → Application → Domain）
end note

ScenarioUI -> ApiClient: getCurrentEvent(scenarioId)
activate ApiClient

ApiClient -> Service: POST /api/game/get-current-event
activate Service

note right of Service
  サーバー側でセッションからcurrentTurnを取得:
  1. SessionStoreからGameSessionを取得
  2. session.currentTurnを使用
  3. クライアントからは渡さない（改ざん防止）
end note

Service -> SessionStore: getSession()
activate SessionStore
SessionStore --> Service: GameSession
deactivate SessionStore

Service -> Scenario: getEventByTurn(session.currentTurn)
activate Scenario
Scenario --> Service: Event
deactivate Scenario

Service --> ApiClient: Event（必要な情報のみ）
deactivate Service

ApiClient --> ScenarioUI: Event
deactivate ApiClient

note right of ScenarioUI
  シナリオUIは取得したイベントデータを
  子コンポーネント（EventUI）にpropsとして渡す
  （ルール3: 親がサービスに依存、子はpropsのみ）
end note

ScenarioUI -> EventUI: displayEvent(eventData)
activate EventUI

note right of EventUI
  EventUIはpropsのみに依存:
  - タイトル表示
  - 説明文表示
  GameServiceには依存しない
end note

EventUI --> Player: イベントタイトルと詳細を表示
deactivate EventUI

ScenarioUI -> ChoiceUI: displayChoices(choicesData)
activate ChoiceUI

note right of ChoiceUI
  ChoiceUIはpropsのみに依存:
  - 選択肢ボタン表示
  GameServiceには依存しない
end note

ChoiceUI --> Player: 選択肢ボタンを表示
deactivate ChoiceUI

deactivate ScenarioUI

note right of ScenarioUI
  シナリオUI配下で表示:
  - EventUI: タイトルと詳細
  - ChoiceUI: 選択肢ボタン

  ※GameAnimationとは独立
  ※上半分の描画とは連動しない
end note

== 選択肢の選択（パラメータ変化） ==

Player -> ChoiceUI: 選択肢をクリック
activate ChoiceUI

note right of ChoiceUI
  ChoiceUIは親（シナリオUI）にイベント通知
  （ルール3: 子は描画とイベント通知に専念）
end note

ChoiceUI -> ScenarioUI: onChoiceSelected(choiceId)
activate ScenarioUI
deactivate ChoiceUI

note right of ScenarioUI
  シナリオUIがGameApiClient経由で選択肢を実行
  （ルール1: UI → ApiClient → Application → Domain）
end note

ScenarioUI -> ApiClient: executeChoice(scenarioId, choiceId)
activate ApiClient

ApiClient -> Service: POST /api/game/execute-choice
activate Service

Service -> SessionStore: getSession()
activate SessionStore
SessionStore --> Service: GameSession (with Cat)
deactivate SessionStore

Service -> Scenario: getEventByTurn(session.currentTurn)
activate Scenario
Scenario --> Service: Event
deactivate Scenario

Service -> Event: getChoiceById(choiceId)
activate Event
Event --> Service: Choice
deactivate Event

Service -> Choice: getResult()
activate Choice
Choice --> Service: EventResult
deactivate Choice

Service -> EventResult: getChanges()
activate EventResult
EventResult --> Service: ParameterChange[]
deactivate EventResult

loop パラメータ変化ごと
  Service -> Cat: applyChange(parameterChange)
  activate Cat
  Cat --> Service: 更新されたCat
  deactivate Cat
end

Service -> SessionStore: saveSession(session with updated cat)
activate SessionStore
SessionStore --> Service: 保存完了
deactivate SessionStore

Service --> ApiClient: 更新されたCat
deactivate Service

ApiClient --> ScenarioUI: 更新されたCat
deactivate ApiClient

note right of ScenarioUI
  猫の状態が更新される
  （例: なつき度 +10, ストレス -5）

  結果テキストはまだ表示しない
  （分岐後に表示）
end note

ScenarioUI --> Player: 選択肢が受け付けられた旨を表示

deactivate ScenarioUI

== 分岐処理と結果テキスト表示 ==

Player -> ResultUI: 次へボタンクリック
activate ResultUI

note right of ResultUI
  ResultUIは親（シナリオUI）にイベント通知
  （ルール3: 子は描画とイベント通知に専念）
end note

ResultUI -> ScenarioUI: onNextClicked()
activate ScenarioUI
deactivate ResultUI

note right of ScenarioUI
  シナリオUIがGameApiClient経由で分岐を評価
  （ルール1: UI → ApiClient → Application → Domain）
end note

ScenarioUI -> ApiClient: evaluateBranch(scenarioId, choiceId)
activate ApiClient

ApiClient -> Service: POST /api/game/evaluate-branch
activate Service

Service -> SessionStore: getSession()
activate SessionStore
SessionStore --> Service: GameSession (with Cat)
deactivate SessionStore

Service -> Scenario: getBranchByTurn(session.currentTurn)
activate Scenario
Scenario --> Service: Branch
deactivate Scenario

Service -> Branch: evaluate(session.cat, choiceId)
activate Branch

note right of Branch
  分岐条件を評価:
  - 選んだ選択肢
  - 猫の現在の状態（セッションから取得）
  に基づいて次イベントを決定
end note

Branch --> Service: nextEventId
deactivate Branch

Service -> Scenario: getEventById(nextEventId)
activate Scenario
Scenario --> Service: 次のEvent（分岐後）
deactivate Scenario

Service --> ApiClient: 次のEvent（分岐後、必要な情報のみ）
deactivate Service

ApiClient --> ScenarioUI: 次のEvent（分岐後）
deactivate ApiClient

note right of ScenarioUI
  シナリオUIは取得した分岐後イベントデータを
  子コンポーネント（ResultUI）にpropsとして渡す
  （ルール3: 親がサービスに依存、子はpropsのみ）
end note

ScenarioUI -> ResultUI: displayResult(resultData)
activate ResultUI

note right of ResultUI
  ResultUIはpropsのみに依存:
  - タイトル: 「選択の結果」
  - 説明文: 結果テキスト
  GameServiceには依存しない
end note

ResultUI --> Player: 結果テキストを表示\n（分岐後のイベント内容）
deactivate ResultUI

deactivate ScenarioUI

== ターン進行 ==

ScenarioUI -> ApiClient: advanceToNextTurn()
activate ScenarioUI
activate ApiClient

ApiClient -> Service: POST /api/game/advance-turn
activate Service

note right of Service
  GameServiceがセッション更新を担当:
  1. SessionStoreからGameSessionを取得
  2. currentTurnをインクリメント
  3. セッションに保存
  （ルール1: UI → ApiClient → Application → Domain）
end note

Service -> SessionStore: getSession()
activate SessionStore
SessionStore --> Service: GameSession
deactivate SessionStore

Service -> Session: advanceTurn()
activate Session

note right of Session
  GameSession: セッション情報のみを保持
  - scenarioId
  - currentTurn（サーバー側で管理）
  - catId
end note

Session --> Service: 更新されたSession
deactivate Session

Service -> SessionStore: saveSession(updated session)
activate SessionStore
SessionStore --> Service: 保存完了
deactivate SessionStore

Service --> ApiClient: 更新されたSession
deactivate Service

ApiClient --> ScenarioUI: 更新されたSession
deactivate ApiClient

ScenarioUI -> ApiClient: isScenarioComplete(scenarioId)
activate ApiClient

ApiClient -> Service: POST /api/game/is-complete
activate Service

Service -> SessionStore: getSession()
activate SessionStore
SessionStore --> Service: GameSession
deactivate SessionStore

Service -> Scenario: isComplete(session.currentTurn)
activate Scenario

alt シナリオ完了
  Scenario --> Service: true
  Service --> ApiClient: true
  deactivate Service
  ApiClient --> ScenarioUI: true
  deactivate ApiClient
  ScenarioUI -> Canvas: onGameEnd(cat, session)
  activate Canvas
  Canvas -> Canvas: 終了処理（結果保存）
  Canvas --> Player: 終了画面表示
  deactivate Canvas
else まだ続く
  Scenario --> Service: false
  Service --> ApiClient: false
  deactivate Service
  ApiClient --> ScenarioUI: false
  deactivate ApiClient
  ScenarioUI -> ScenarioUI: 次のイベント表示へ
  note right of ScenarioUI
    「== イベント表示 ==」に戻る
  end note
end

deactivate Scenario
deactivate ScenarioUI

@enduml
