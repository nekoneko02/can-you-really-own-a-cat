# ドメイン層実装ガイド

## エンティティ vs 値オブジェクト

### エンティティ
- 一意性（ID）を持つ
- ライフサイクルを通じて変化する
- 例: Cat, User

### 値オブジェクト
- 属性値によって識別される
- 不変（イミュータブル）
- 等価性比較が可能
- 例: Position, Emotion, FriendshipLevel

## エンティティ作成チェックリスト

1. **ID管理**: 一意性を持つIDプロパティを実装
2. **ライフサイクル**: 状態変化を表現するメソッドを実装
3. **ドメインロジック**: ビジネスルールをエンティティ内に配置
4. **テスト作成**: 必ずテストファーストで実装（@docs/guidelines/05_testing.md）

## 値オブジェクト作成チェックリスト

1. **不変性**: 一度生成したら変更不可、変更は新しいインスタンスを返す
2. **等価性**: `equals()`メソッドで属性値による比較を実装
3. **範囲制限**: コンストラクタで値の範囲をバリデーション
4. **テスト作成**: 境界値テストを含む単体テストを作成

## モジュール公開ルール（index.ts + @internal）

サブドメイン間の依存関係を明確にするため、公開対象は `index.ts` で管理する。

### 基本方針

1. **外部に公開したいものだけ `index.ts` から export する**
2. `index.ts` から export されていないファイル・クラス・関数は **サブドメイン内部専用**
3. 他サブドメインから import する場合は **必ず `index.ts` 経由で行う**
4. ファイル直指定での import は禁止（内部依存の発生を防ぐため）

### JSDoc コメントルール

内部専用の要素には `@internal` を付ける。

```typescript
/**
 * @internal
 * このクラスはサブドメイン内部専用。外部から直接利用しない。
 */
```

外部から直接 `new` させたくないコンストラクタも同様に示す。

```typescript
/**
 * @internal
 * このコンストラクタは外部から呼び出さない。
 * 必要な場合は Factory / Registry 経由で生成する。
 */
```

### import の使用例

| 状態 | 書き方 | 判定 |
|---|---|---|
| 正しい | `import { OrderService } from "@/order";` | ✔ `index.ts` 経由 |
| 誤り | `import { OrderValidator } from "@/order/domain/OrderValidator";` | ✘ 直 import（外部依存） |

### 運用チェック

コミット前に次を確認する:

- 他サブドメインの内部ファイルを `直 import` していないか
- `index.ts` の export が意図した公開範囲になっているか
- 内部専用の要素には `@internal` が付いているか

## ドメインモデル図の更新

### 記載ルール

1. **Public メソッド・プロパティ**: すべて記載
2. **`index.ts` から export されているクラス・関数**: すべて記載
3. **Private メソッド・プロパティ**: 記載不要
4. **`@internal` の要素**: 記載不要

### 更新タイミング

- public メソッド・プロパティを追加・変更・削除した時
- `index.ts` の export を変更した時
- リファクタリング後

### 更新対象

`@docs/aidlc/inception/ドメインモデル.pu`
